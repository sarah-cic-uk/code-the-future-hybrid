<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="Code, Future, HTML, CSS, JavaScript, IBM, CIC" />
  <meta name="description" content="Code the Future free HTML/CSS coding bootcamp" />
  <meta name="author" content="Sarah Neenan" />
  <title>Code the Future</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" />
  <script type="text/javascript" src="./js/app.js"></script>
  <!-- <script  src="./js/imports.js"></script> -->
  <script type="module" src="./js/firebase.js"></script>
</head>

<body>
  <div class="page-content">

    <nav class="navbar navbar-expand-lg bg-light">
      <a href="#main" class="skip-to-main-content-link">Skip to main content</a>
      <div class="container-fluid g-0">
        <a onclick="createPath('index.html')" class="navbar-brand" href="#">
          <img src="../images/logo.png" height="60px" />
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
          aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarNavAltMarkup">
          <div class="navbar-nav nav-justified">
            <a class="nav-link" aria-current="page" href="#" onclick="createPath('index.html')" title="About CTF">About
              CTF</a>
            <a class="nav-link" aria-current="page" href="#" onclick="createPath('pages/meetTheTutors.html')"
              title="Meet the Tutors">Meet the Tutors</a>
            <a class="nav-link" aria-current="page" href="#" onclick="createPath('pages/1on1.html')"
              title="Schedule a 1:1">Schedule a 1:1</a>
            <a class="nav-link" href="#" onclick="createPath('jobs.html')" title="Jobs at CIC">Jobs at CIC</a>
            <a class="nav-link" href="#" onclick="createPath('pages/courseCatalog.html')" title="Course Catalog">Course
              Catalog</a>
            <a class="nav-link" id="sessionsLink" href="#" onclick="createPath('pages/sessions.html')"
              title="Sessions">Sessions</a>
          </div>
          <div class="d-flex align-items-center">
            <!-- Logged in Avatar -->
            <div>
              <p class="my-auto" id="profileName"></p>
            </div>
            <div class="profileBtn dropdown px-3">
              <a class="btn dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown"
                aria-expanded="false">
                <img src="https://mdbcdn.b-cdn.net/img/new/avatars/2.webp" class="rounded-circle" height="25"
                  alt="Black and White Portrait of a Man" loading="lazy" />
              </a>

              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby=" dropdownMenuLink">
                <li> <a class="dropdown-item" href="#" onclick="createPath('pages/profile.html')" title="My profile">My
                    profile</a> </li>
                <li> <a class="dropdown-item" href="#" onclick="createPath('pages/cohort.html')"
                    title="View cohort">View cohort</a> </li>
                <li> <a class="dropdown-item logout" href="#" onclick="logUserOut()" title="Logout">Logout</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </nav>


    <div class="container-fluid">
      <div class="row flex-nowrap page-content">
        <main id="main" class="col py-3">

          <div class="container">
            <section>
              <h1 id="profileHeading" class="h1"></h1>
              <h2 class="h4">Let us know more about yourself</h2>
              <p>What are your aspirations and goals so that the tutors and others from your Code the Future cohort can
                get to know you better.</p>
            </section>

            <section class="row" style="margin-bottom:4rem">
              <div class="col">

                <form onsubmit="updateProfile()">
                  <fieldset>
                    <legend>Profile form</legend>

                    <div class="form-group" style="margin-top:1rem;">
                      <label class="profile-question text-start form-label" for="who">Tell us who you are</label>
                      <div class="input-group">
                        <textarea rows="3" class="form-control" id="who" name="who" placeholder="Let us know more about yourself."></textarea>
                      </div>
                    </div>

                    <div class="form-group" style="margin-top:1rem;">
                      <label class="profile-question text-start form-label" for="what">What are you hoping to learn from this course?</label>
                      <div class="input-group">
                        <textarea rows="3" class="form-control" id="what" name="what" placeholder="Let us know what made you sign up and what you would like to achieve from it."></textarea>
                      </div>
                    </div>

                    <div class="form-group" style="margin-top:1rem;">
                      <label class="profile-question text-start form-label" for="career">What are your career aspirations?</label>
                      <div class="input-group">
                        <textarea rows="3" class="form-control"id="career" name="career" placeholder="Let us know where you would like to see yourself in the future, what fascinating path could your career journey lead you?"></textarea>
                      </div>
                    </div>

                    <div class="CTA-group">
                      <input type="reset" value="Clear" id="reset" class="btn nav-link" />
                      <input type="submit" value="Save profile" id="submit" class="btn button-generic primary" />
                    </div>
                  </fieldset>
                </form>
              </div>

              <div class="col" style="margin-top:4rem">
                <div class="d-flex justify-content-center mb-4">
                  <img id="selectedAvatar" class="rounded-circle" alt="Cohort avatar" />
                </div>

                <div class="text-center">
                  <div data-mdb-ripple-init class="mt-1 btn btn-rounded"
                    style="background-color: #1d0c58; color: white">
                    <input class="form-control" type="file" id="formFile" onchange="displaySelectedImage(event, 'selectedAvatar')" />
                    <label class="form-label text-white m-1" for="profilePic">Update profile picture</label>
                  </div>
                </div>
              </div>
            </section>

          </div>

        </main>
      </div>
    </div>


    <script defer type="module">
      import { fbAuth, fbDB } from "./js/firebase.js";
      window.fbAuth = fbAuth;
      window.fbDB = fbDB;
    </script>
    <script type="text/javascript">
      const stylesheet = document.createElement("link");
      stylesheet.rel = "stylesheet";
      stylesheet.type = "text/css";
      stylesheet.href = getPath() + "styles/mainStyle.css";
      document.head.appendChild(stylesheet);
      let currentUser = null;
      const who = document.getElementById('who');
      const what = document.getElementById('what');
      const career = document.getElementById('career');

      window.onload = (event) => {
        console.log("Load")
        auth(
          document.querySelector(".loginBtn"),
          document.querySelector(".profileBtn"),
          document.querySelector("#sessionsLink")
        );
        const user = localStorage.getItem("displayName");
        document.getElementById("profileHeading").innerHTML = `${user}'s Profile`;

        getProfile();
      };

      function createPath(options) {
        window.location = getPath() + options;
        return false;
      }

      function logUserOut(event) {
        logout(window.fbAuth);
      }

      function displaySelectedImage(event, elementId) {
        const selectedImage = document.getElementById(elementId);
        const fileInput = event.target;
        if (fileInput.files && fileInput.files[0]) {
          const reader = new FileReader();

          reader.onload = function (e) {
            selectedImage.src = e.target.result;
          };

          reader.readAsDataURL(fileInput.files[0]);
          const storageRef = window.fbStorage.ref("profilePics/" + fileInput.files[0].name.split('.')[0]);
          storageRef.put(fileInput.files[0]);

        }
      }

      async function getProfile() {
        window.fbAuth.onAuthStateChanged(async function (user) {
          if (user) {
            currentUser = window.fbAuth.currentUser;
            const profileData = await window.fbDB.ref('users/' + currentUser.uid + '/profile').once('value')
            const profileValues = profileData.val();
            who.innerHTML = profileValues.about
            what.innerHTML = profileValues.learning
            career.innerHTML = profileValues.aspirations
            const profilePicElement = document.getElementById("selectedAvatar");
            const pathReference = await window.fbStorage.ref("profilePics/" + currentUser.uid);
            if (pathReference) {
              fetchMedia(pathReference, profilePicElement);
            } else {
              profilePicElement.setAttribute('src', 'https://mdbootstrap.com/img/Photos/Others/placeholder-avatar.jpg');
            }
          }
          else {
            console.err('ERROR: User data not found')
          }
        })
      }

      async function updateProfile() {
        let profileValues = {};
        profileValues.about = who.value;
        profileValues.learning = what.value;
        profileValues.aspirations = career.value;

        var updates = {};
        updates['users/' + currentUser.uid + '/profile'] = profileValues;
        await window.fbDB.ref().update(updates);
      }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
      crossorigin="anonymous"></script>
</body>

</html>
<style>
  form {
    width: 100%;
  }

  legend {
    display: block;
    text-indent: 100%;
    white-space: nowrap;
    overflow: hidden;
  }

  textarea {
    width: 100%;
    padding: 12px 20px;
    margin: 8px 0;
    box-sizing: border-box;
  }

  .rounded-circle {
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
  }
</style>