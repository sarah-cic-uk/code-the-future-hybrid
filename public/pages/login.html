<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="keywords" content="Code, Future, HTML, CSS, JavaScript, IBM, CIC"/>
    <meta name="description" content="Code the Future free HTML/CSS coding bootcamp"/>
    <meta name="author" content="Sarah Neenan" />
    <title>Code the Future</title>

  <!-- Load Firebase core first -->
  <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-app.js"></script>

  <!-- Load other Firebase SDK's -->
  <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.14.1/firebase-database.js"></script>

  <!-- Initialise Firebase -->
  <script type="module" src="./js/firebase.js"></script>

  <!-- Load application functions -->
  <script type="text/javascript" src="./js/app.js"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

  <!-- Load stylesheets -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
  integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">

  <link rel="stylesheet" href="../styles/mainStyle.css">


</head>

<body>

  <script type="module">

    // Import fbAuth and fbDb from Firebase
    import { fbAuth, fbDB } from "./js/firebase.js";

    // Confirm Firebase variables are defined
    console.log("Accessing fbAuth and fbDB from login.html...");

    console.log("window.fbAuth:", window.fbAuth);
    console.log("window.fbDB:", window.fbDB);
    
    console.log("fbAuth:", fbAuth);
    console.log("fbDB:", fbDB);

  </script>

  <div class="page-body">
    <nav class="navbar navbar-expand-lg bg-light">
      <div class="container-fluid g-0">
        <a onclick="createPath('index.html')" class="navbar-brand" href="#" style="
              border-right: 2px solid #d9437a;
              padding-right: 10px;
              color: #1d0c59;
            ">
          <img src="../images/logo.png" height=60px />
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
          aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav nav-justified">
            <a class="nav-link" aria-current="page" href="#" onclick="createPath('index.html')">About CTF</a>
            <a class="nav-link" aria-current="page" href="#" onclick="createPath('pages/meetTheTutors.html')">Meet the
              tutors</a>
            <a class="nav-link" aria-current="page" href="#" onclick="createPath('pages/1on1.html')">Schedule a 1:1</a>
            <a class="nav-link" href="#" onclick="createPath('jobs.html')">Jobs at CIC</a>
            <a class="nav-link" href="#" onclick="createPath('pages/courseCatalog.html')">Course Catalog</a>
          </div>
        </div>
      </div>
  </div>
  </nav>
  <div class="container-fluid">
    <div class="row flex-nowrap page-content">
      <section class="gradient-form">
        <div>
          <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="px-0" style="height:calc(100vh - 70px)">
              <div class="text-black">
                <div class="row g-0" style="height:calc(100vh - 70px)">
                  <div class="col-lg-6">
                    <div class=" p-md-5 mx-md-4">

                      <div class="text-center">
                        <img src="../images/logo.png" style="width: 285px;" alt="logo">
                        <h4 class="mt-4 mb-5 pb-1">Log in to access your learning</h4>
                      </div>

                      <form onsubmit="login(window.fbAuth)">
                        <div class="form-outline mb-4">
                          <label class="form-label" for="email">Username</label>
                          <div class="input-group">
                            <div class="input-group-text"><i class="bi bi-person-fill"></i></div>
                            <input type="email" id="email" class="form-control" placeholder="Registered email address"
                              autocomplete="current-email" />
                          </div>
                        </div>

                        <div class="form-outline mb-5">
                          <label class="form-label" for="password">Password</label>
                          <div class="input-group">
                            <div class="input-group-text"><i class="bi bi-lock-fill"></i></div>
                            <input type="password" id="password" class="form-control" autocomplete="current-password" />
                            <span class="input-group-text" id="password-input">
                              <i class="bi bi-eye-slash togglePassword"></i>
                            </span>
                          </div>
                        </div>

                        <div class="text-center pt-1 mb-1">
                          <button class="btn btn-block fa-lg mb-3 button-style" type="submit">Log In</button>
                        </div>
                      </form>

                      <div class="text-center mb-5 pb-1">
                        <a class="text-muted" href="#!">Forgot password?</a>
                      </div>

                      <div class="d-flex align-items-center justify-content-center pb-4">
                        <p class="mb-0 me-2">Don't have an account?</p>
                        <button type="button" class="btn btn-register" data-bs-toggle="modal"
                          data-bs-target="#registrationModal">
                          Register
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="col-lg-6 d-flex align-items-center gradient-custom-2">
                    <div class="text-white px-3 py-4 p-md-5 mx-md-4">
                      <h4 class="mb-4">Log in to access your learning</h4>
                      <p class="small mb-0" style="width: 400px">Log in to access your cohorts sessions, view the
                        course timetable and book 1:1s with tutors </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
  <div class="modal fade" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header text-center">
          <h4 class="modal-title w-100 font-weight-bold">Sign up</h4>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body mx-3">
          <form class="needs-validation" novalidate>
            <div class="form-group">
              <label for="displayName">Display Name<span class="text-danger">*</span></label>
              <div class="input-group">
                <div class="input-group-text"><i class="bi bi-person-fill"></i></div>
                <input type="text" class="form-control form-control-lg" name="displayName" id="displayName"
                  autocomplete="new-name" required>
              </div>
            </div>
            <div class="form-group col-12">
              <label for="newEmail">Email<span class="text-danger">*</span></label>
              <div class="input-group flex-nowrap">
                <div class="input-group-text"><i class="bi bi-envelope-fill"></i></div>
                <input type="text" class="form-control form-control-lg" name="newEmail" id="newEmail" required
                  autocomplete="new-email">
              </div>
            </div>
            <div class="form-group">
              <label>Password<span class="text-danger">*</span></label>
              <div class="input-group flex-nowrap">
                <div class="input-group-text"><i class="bi bi-lock-fill"></i></div>
                <input type="password" class="form-control form-control-lg" id="newPassword" required
                  autocomplete="new-password" />
                <span class="input-group-text" id="newPasswordInput">
                  <i class="bi bi-eye-slash toggleNewPassword"></i>
                </span>
              </div>
            </div>
            <div class="form-group">
              <label>Confirm Password<span class="text-danger">*</span></label>
              <div class="input-group flex-nowrap">
                <div class="input-group-text"><i class="bi bi-lock-fill"></i></div>
                <input type="password" class="form-control form-control-lg" id="passwordCheck" name="passwordCheck"
                  required autocomplete="new-password" />
                <span class="input-group-text" id="passwordCheckInput">
                  <i class="bi bi-eye-slash togglePasswordCheck"></i>
                </span>
              </div>
              <div id="passwordMatch" class="hidden-feedback">Passwords must match</div>
            </div>
            <div class="form-group">
              <label>Cohort Access Code<span class="text-danger">*</span></label>
              <div class="input-group flex-nowrap">
                <div class="input-group-text"><i class="bi bi-people-fill"></i></div>
                <input type="text" class="form-control form-control-lg" name="cohortCode" id="cohortCode" required />
              </div>
              <div id="cohortCodeCheck" class="hidden-feedback">Invalid Code</div>
            </div>
            <div class="form-group py-4 text-center">
              <button class="btn" style="background-color: #d9437a; color: white" id="btnLogin"
                onclick="validateAndRegister()">Sign
                up!</button>
            </div>
            <div class="float-end mb-1" data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false"
            aria-controls="collapseExample">
              <a class="small" style="cursor: pointer;">
                view data privacy information<i class="bi bi-shield-exclamation ms-1" style="color: #1d0c59;"></i>
              </a>
            </div>

            <div class="collapse" id="collapseExample" style="clear:both">
              <div class="data-privacy-message alert alert-warning">
                <div>Your data will not be shared within IBM or with any external companies. Any information stored will
                  be removed after 5 years of user inactivity</div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!--  -->
  </div>
  <script type="module">
    import { fbAuth, fbDB } from "./js/firebase.js";
    window.fbAuth = fbAuth;
    window.fbDB = fbDB;
  </script>
  <script type="text/javascript">
    const stylesheet = document.createElement('link');
    stylesheet.rel = 'stylesheet';
    stylesheet.type = 'text/css';
    stylesheet.href = getPath() + 'styles/mainStyle.css';
    document.head.appendChild(stylesheet);

    window.onload = (event) => {
      auth(document.querySelector(".loginBtn"), document.querySelector(".profileBtn"), document.querySelector("#sessionsLink"))
    }

    function createPath(options) {
      window.location = getPath() + options;
      return false;
    }

    function logUserOut(event) {
      logout(window.fbAuth)
      console.log('User logged out: ', fbAuth);
    }

    async function validateAndRegister() {
      console.log('validateForm')

      const forms = document.querySelectorAll('.needs-validation')

      Array.from(forms).forEach(async form => {
        console.log("2")

        form.addEventListener('submit', async event => {
          console.log("3")

          const password = document.getElementById('newPassword').value;
          const passwordRepeat = document.getElementById('passwordCheck').value;
          const matchingPasswords = password === passwordRepeat
          const cohortCode = document.getElementById('cohortCode').value;
          const validCode = await validateCohortCode(cohortCode)
          console.log("1", validCode)
          if (!matchingPasswords) {
            document.getElementById('passwordMatch').classList.remove("hidden-feedback");
            document.getElementById('passwordMatch').classList.add("invalid-feedback");
            event.preventDefault()
            event.stopPropagation()
          } else if (!validCode) {
            document.getElementById('cohortCodeCheck').classList.remove("hidden-feedback");
            document.getElementById('cohortCodeCheck').classList.add("invalid-feedback");
            event.preventDefault()
            event.stopPropagation()
          } else if (!form.checkValidity()) {
            event.preventDefault()
            event.stopPropagation()
          } else {
            registerNewUser()
          }
          form.classList.add('was-validated')
        }, false)
      })
    }


    async function validateCohortCode(cohortCode) {
      console.log('validateCohortCode', window.fbDB)

      const possibleCodes = await window.fbDB.ref('cohorts/').once('value')
      console.log("codes", possibleCodes)

      const possibleCodes1 = possibleCodes.val();
      console.log("codes1", possibleCodes1)
      return possibleCodes.find(obj => obj.code === cohortCode)?.id;
    }


    async function registerNewUser() {
      console.log('registerNewUser')

      const email = document.getElementById('newEmail').value;
      const password = document.getElementById('newPassword').value;
      const passwordRepeat = document.getElementById('passwordCheck').value;
      const name = document.getElementById('displayName').value;
      const cohortCode = document.getElementById('cohortCode').value;
      const validCode = await validateCohortCode(cohortCode)
      try {

        await window.fbAuth.createUserWithEmailAndPassword(email, password)
          .catch((error) => {
            console.log(error.code)
            console.log(error.message)
          })

        const user = window.fbAuth.currentUser;

        await user.sendEmailVerification().catch((err) =>
          console.log(err)
        );

        await user.updateProfile({ displayName: name }).catch(
          (err) => console.log(err)
        );

        window.fbAuth.onAuthStateChanged(async (user) => {
          if (user) {
            localStorage.setItem('loggedIn', true);
            localStorage.setItem('displayName', user.displayName);
            await addUserToDatabase(user, validCode);
            window.location.replace("./sessions.html");
          } else {
            localStorage.removeItem('loggedIn');
            localStorage.removeItem('displayName');
          }
        });
      } catch (err) {
        console.log(err);
      }
    };

    async function addUserToDatabase(user, cohortId) {
      await window.fbDB.ref('users/' + user.uid).set({ displayName: user.displayName, email: user.email, cohort: cohortId });
    }

  function login(fbAuth) {
  event.preventDefault();
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  fbAuth.signInWithEmailAndPassword(email, password)
    .then((userCredential) => {
      console.log('User logged in successfully:', userCredential);
      localStorage.setItem('loggedIn', true);
      const user = firebase.auth().currentUser;
      localStorage.setItem('displayName', user.displayName);
      window.location.replace("./sessions.html");
    })
    .catch((error) => {
      console.error('Error signing in:', error.message);
    });
  };
  </script>

  <script>
    const toggleNewPassword = document.querySelector('.toggleNewPassword');
    const togglePasswordCheck = document.querySelector('.togglePasswordCheck');
    const password = document.querySelector('.togglePassword');
    const newPasswordEl = document.getElementById('newPassword');
    const passwordCheckEl = document.getElementById('passwordCheck');
    const passwordEl = document.getElementById('password');
    toggleNewPassword.addEventListener('click', (e) => {
      const type = newPasswordEl
        .getAttribute('type') === 'password' ?
        'text' : 'password';
      newPasswordEl.setAttribute('type', type);
      e.target.classList.toggle('bi-eye');
    });
    togglePasswordCheck.addEventListener('click', (e) => {
      const type = passwordCheckEl
        .getAttribute('type') === 'password' ?
        'text' : 'password';
      passwordCheckEl.setAttribute('type', type);
      e.target.classList.toggle('bi-eye');
    });
    password.addEventListener('click', (e) => {
      const type = passwordEl
        .getAttribute('type') === 'password' ?
        'text' : 'password';
      passwordEl.setAttribute('type', type);
      e.target.classList.toggle('bi-eye');
    });
  </script>
</body>
</html>