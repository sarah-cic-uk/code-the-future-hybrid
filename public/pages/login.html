<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="Code, Future, HTML, CSS, JavaScript, IBM, CIC" />
  <meta name="description" content="Code the Future free HTML/CSS coding bootcamp" />
  <meta name="author" content="Sarah Neenan" />
  <title>Code the Future</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
  <script type="text/javascript" src="./js/app.js"></script>
  <!-- <script  src="./js/imports.js"></script> -->
  <script type="module" src="./js/firebase.js"></script>
</head>

<body>
  <div class="page-body">
    <nav class="navbar navbar-expand-lg bg-light">
      <div class="container-fluid g-0">
        <a onclick="createPath('index.html')" class="navbar-brand" href="#" style="
              border-right: 2px solid #d9437a;
              padding-right: 10px;
              color: #1d0c59;
            ">
          <img src="../images/logo.png" height="60px" alt="CTF" />
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
          aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
          <div class="navbar-nav nav-justified">
            <a class="nav-link" aria-current="page" href="#" onclick="createPath('index.html')" title="About CTF">About CTF</a>
            <a class="nav-link" aria-current="page" href="#" onclick="createPath('pages/meetTheTutors.html')" title="Meet the Tutors">Meet the Tutors</a>
            <a class="nav-link" aria-current="page" href="#" onclick="createPath('pages/1on1.html')" title="Schedule a 1:1">Schedule a 1:1</a>
            <a class="nav-link" href="#" onclick="createPath('jobs.html')" title="Jobs at CIC">Jobs at CIC</a>
            <a class="nav-link" href="#" onclick="createPath('pages/courseCatalog.html')" title="Course Catalog">Course Catalog</a>
          </div>
        </div>
      </div>
    </nav>

    
    <div class="container-fluid">
      <div class="row flex-nowrap page-content">
        <section class="gradient-form">

          <main>
            <div class="row d-flex justify-content-center align-items-center h-100">
              <div class="px-0">
                <div class="text-black">
                  <div class="row g-0">

                    <div class="col-lg-6">
                      <div class=" p-md-5 mx-md-4">

                        <div class="text-center">
                          <img src="../images/logo.png" style="width: 285px;" alt="logo">
                        </div>

                        <div class="login">
                          <h1 class="h1">Login</h1>
                          <h2 class="h2">Access to your Code the Future learning</h2>
                          <p>Login to access your cohorts sessions, view the course timetable and book 1:1s with tutors.</p>
                        </div>

                        <form onsubmit="login(window.fbAuth)">
                          <div class="form-outline mb-4">
                            <label class="form-label" for="email">Username</label>
                            <div class="input-group">
                              <div class="input-group-text"><i class="bi bi-person-fill"></i></div>
                              <input type="email" id="email" name="email" class="form-control" placeholder="Registered email address" autocomplete="email" />
                            </div>
                          </div>

                          <div class="form-outline mb-5">
                            <label class="form-label" for="password">Password</label>
                            <div class="input-group">
                              <div class="input-group-text"><i class="bi bi-lock-fill"></i></div>
                              <input type="password" id="password" name="password" class="form-control" autocomplete="current-password" />
                              <span class="input-group-text" id="password-input">
                                <i class="bi bi-eye-slash togglePassword"></i>
                              </span>
                            </div>
                          </div>

                          <div class="text-center pt-1 mb-1">
                            <button class="btn btn-block fa-lg mb-3 button-generic primary" type="submit" title="Login">Login</button>
                          </div>
                        </form>

                        <div class="text-center mb-5 pb-1">
                          <a class="text-muted" href="#!" title="Forgot password?">Forgot password?</a>
                        </div>

                        <div class="d-flex align-items-center justify-content-center pb-4">
                          <p class="mb-0 me-2">Don't have an account?</p>
                          <button type="button" class="btn btn button-generic tertiary" data-bs-toggle="modal" data-bs-target="#registrationModal" title="Register">
                            Register
                          </button>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-6 d-flex align-items-center gradient-custom-2">
                      <div class="text-white px-3 py-4 p-md-5 mx-md-4">
                        <h1 id="welcome-heading" class="login-title">Code the Future</h1>
                        <h2 class="h4 login-blurb">Let's learn to build a website together</h2>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </main>
        </section>
      </div>
    </div>

    <div class="modal fade" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel"
      aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header text-center">
            <h4 class="modal-title w-100 font-weight-bold">Sign up</h4>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body mx-3">
            <form class="needs-validation" novalidate>
              <div class="form-group" style="margin-top:1rem;">
                <label for="displayName">Display name <span class="text-danger">*</span></label>
                <div class="input-group">
                  <div class="input-group-text"><i class="bi bi-person-fill"></i></div>
                  <input type="text" class="form-control form-control-lg" name="displayName" id="displayName" autocomplete="new-name" required />
                </div>
              </div>

              <div class="form-group" style="margin-top:1rem;">
                <label for="newEmail">Email <span class="text-danger">*</span></label>
                <div class="input-group flex-nowrap">
                  <div class="input-group-text"><i class="bi bi-envelope-fill"></i></div>
                  <input type="text" class="form-control form-control-lg" name="newEmail" id="newEmail" autocomplete="new-email" required />
                </div>
              </div>

              <div class="form-group" style="margin-top:1rem;">
                <label for="newPassword">Password <span class="text-danger">*</span></label>
                <div class="input-group flex-nowrap">
                  <div class="input-group-text"><i class="bi bi-lock-fill"></i></div>
                  <input type="password" class="form-control form-control-lg" name="newPassword" id="newPassword" autocomplete="new-password" required />
                  
                  <span class="input-group-text" id="newPasswordInput">
                    <i class="bi bi-eye-slash toggleNewPassword"></i>
                  </span>
                </div>
              </div>

              <div class="form-group" style="margin-top:1rem;">
                <label for="passwordCheck">Confirm password <span class="text-danger">*</span></label>
                <div class="input-group flex-nowrap">
                  <div class="input-group-text"><i class="bi bi-lock-fill"></i></div>
                  <input type="password" class="form-control form-control-lg" id="passwordCheck" name="passwordCheck" autocomplete="new-password" required />
                  
                  <span class="input-group-text" id="passwordCheckInput">
                    <i class="bi bi-eye-slash togglePasswordCheck"></i>
                  </span>
                </div>
                <div id="passwordMatch" class="hidden-feedback">Passwords must match.</div>
              </div>

              <div class="form-group" style="margin-top:1rem;">
                <label for="cohortCode">Cohort access code <span class="text-danger">*</span></label>
                <div class="input-group flex-nowrap">
                  <div class="input-group-text"><i class="bi bi-people-fill"></i></div>
                  <input type="text" class="form-control form-control-lg" name="cohortCode" id="cohortCode" required />
                </div>
                <div id="cohortCodeCheck" class="hidden-feedback">Invalid code</div>
              </div>

              <div class="form-group py-4 text-center">
                <button class="btn button-generic primary" id="btnLogin" onclick="validateAndRegister()" title="Sign up">Sign up</button>
              </div>

              <div class="float-end mb-1" data-bs-toggle="collapse" data-bs-target="#collapseExample"
                aria-expanded="false" aria-controls="collapseExample">
                <a class="small" style="cursor: pointer;" title="View data privacy information">
                  View data privacy information <i class="bi bi-shield-exclamation ms-1" style="color: #1d0c59;"></i>
                </a>
              </div>

              <div class="collapse" id="collapseExample" style="clear:both">
                <div class="data-privacy-message alert alert-warning">
                  <div>Your data will not be shared within IBM or with any external companies. Any information stored will
                    be removed after 5 years of user inactivity.</div>
                </div>
              </div>
            </form>
          </div>

        </div>
      </div>
      <!--  -->
    </div>
  </div>

  <script defer type="module">
    import { fbAuth, fbDB } from "./js/firebase.js"
    window.fbAuth = fbAuth;
    window.fbDB = fbDB;
  </script>

  <script defer type="text/javascript">
    const stylesheet = document.createElement('link');
    stylesheet.rel = 'stylesheet';
    stylesheet.type = 'text/css';
    stylesheet.href = getPath() + 'styles/mainStyle.css';
    document.head.appendChild(stylesheet);

    window.onload = (event) => {
      auth(document.querySelector(".loginBtn"), document.querySelector(".profileBtn"), document.querySelector("#sessionsLink"))
    }

    function createPath(options) {
      window.location = getPath() + options;
      return false;
    }

    function logUserOut(event) {
      logout(window.fbAuth)
    }

    async function validateAndRegister() {
      const forms = document.querySelectorAll('.needs-validation')

      Array.from(forms).forEach(async form => {
        form.addEventListener('submit', async event => {
          const password = document.getElementById('newPassword').value;
          const passwordRepeat = document.getElementById('passwordCheck').value;
          const matchingPasswords = password === passwordRepeat
          const cohortCode = document.getElementById('cohortCode').value;
          const validCode = await validateCohortCode(cohortCode)
          console.log("1", validCode)
          if (!matchingPasswords) {
            document.getElementById('passwordMatch').classList.remove("hidden-feedback");
            document.getElementById('passwordMatch').classList.add("invalid-feedback");
            event.preventDefault()
            event.stopPropagation()
          } else if (!validCode) {
            document.getElementById('cohortCodeCheck').classList.remove("hidden-feedback");
            document.getElementById('cohortCodeCheck').classList.add("invalid-feedback");
            event.preventDefault()
            event.stopPropagation()
          } else if (!form.checkValidity()) {
            event.preventDefault()
            event.stopPropagation()
          } else {
            registerNewUser()
          }
          form.classList.add('was-validated')
        }, false)
      })
    }


    async function validateCohortCode(cohortCode) {
      const possibleCodes = await window.fbDB.ref('cohorts/').once('value')
      const possibleCodes1 = possibleCodes.val();
      return possibleCodes.find(obj => obj.code === cohortCode)?.id;
    }


    async function registerNewUser() {

      const email = document.getElementById('newEmail').value;
      const password = document.getElementById('newPassword').value;
      const passwordRepeat = document.getElementById('passwordCheck').value;
      const name = document.getElementById('displayName').value;
      const cohortCode = document.getElementById('cohortCode').value;
      const validCode = await validateCohortCode(cohortCode)
      try {

        await window.fbAuth.createUserWithEmailAndPassword(email, password)
          .catch((error) => {
            console.log(error.code)
            console.log(error.message)
          })

        const user = window.fbAuth.currentUser;

        await user.sendEmailVerification().catch((err) =>
          console.log(err)
        );

        await user.updateProfile({ displayName: name }).catch(
          (err) => console.log(err)
        );

        window.fbAuth.onAuthStateChanged(async (user) => {
          if (user) {
            localStorage.setItem('loggedIn', true);
            localStorage.setItem('displayName', user.displayName);
            await addUserToDatabase(user, validCode);
            window.location.replace("./sessions.html");
          } else {
            localStorage.removeItem('loggedIn');
            localStorage.removeItem('displayName');
          }
        });
      } catch (err) {
        console.log(err);
      }
    };

    async function addUserToDatabase(user, cohortId) {
      await window.fbDB.ref('users/' + user.uid).set({ displayName: user.displayName, email: user.email, cohort: cohortId });
    }

    function login(fbAuth) {
      event.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      window.fbAuth.signInWithEmailAndPassword(email, password)
        .then(async (userCredential) => {
          localStorage.setItem('loggedIn', true);
          const user = window.fbAuth.currentUser;
          localStorage.setItem('displayName', user.displayName);
          window.location.replace("./sessions.html");
        })
        .catch((error) => {
          console.log("error signing in: ", error.message)
        });
    };
  </script>

  <script>
    const toggleNewPassword = document.querySelector('.toggleNewPassword');
    const togglePasswordCheck = document.querySelector('.togglePasswordCheck');
    const password = document.querySelector('.togglePassword');
    const newPasswordEl = document.getElementById('newPassword');
    const passwordCheckEl = document.getElementById('passwordCheck');
    const passwordEl = document.getElementById('password');
    toggleNewPassword.addEventListener('click', (e) => {
      const type = newPasswordEl
        .getAttribute('type') === 'password' ?
        'text' : 'password';
      newPasswordEl.setAttribute('type', type);
      e.target.classList.toggle('bi-eye');
    });
    togglePasswordCheck.addEventListener('click', (e) => {
      const type = passwordCheckEl
        .getAttribute('type') === 'password' ?
        'text' : 'password';
      passwordCheckEl.setAttribute('type', type);
      e.target.classList.toggle('bi-eye');
    });
    password.addEventListener('click', (e) => {
      const type = passwordEl
        .getAttribute('type') === 'password' ?
        'text' : 'password';
      passwordEl.setAttribute('type', type);
      e.target.classList.toggle('bi-eye');
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous">
  </script>

</body>

</html>