<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="Code, Future, HTML, CSS, JavaScript, IBM, CIC" />
  <meta name="description" content="Code the Future free HTML/CSS coding bootcamp" />

  <title>Code the Future</title>

  <link rel="stylesheet" href="../styles/1on1.css" />

  <!-- FullCalendar CSS & JS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  <script type="module" src="./js/firebase.js"></script>
</head>



<body>
  <div class="page-content">

    <nav class="navbar navbar-expand-lg bg-light">
      <div class="container-fluid g-0">
        <a onclick="createPath('index.html')" class="navbar-brand" href="#"
          style="border-right: 2px solid #d9437a;padding-right: 10px;color: #1d0c59;">
          <img src="../images/logo.png" height="60px" alt="CTF" />
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
          aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse justify-content-between" id="navbarNavAltMarkup">
          <div class="navbar-nav nav-justified">
            <a class="nav-link" href="#" onclick="createPath('index.html')">About CTF</a>
            <a class="nav-link" href="#" onclick="createPath('pages/meetTheTutors.html')">Meet the tutors</a>
            <a class="nav-link  active-top-nav" aria-current="page" href="#"
              onclick="createPath('pages/1on1.html')">Schedule a 1:1</a>
            <a class="nav-link" href="#" onclick="createPath('pages/jobs.html')">Jobs at IBM</a>
            <a class="nav-link" href="#" onclick="createPath('pages/courseCatalog.html')">Course Catalog</a>
            <a class="nav-link" id="sessionsLink" href="#" onclick="createPath('pages/sessions.html')">Sessions</a>
            <a class="nav-link" href="#" onclick="createPath('pages/faq.html')">FAQ</a>
          </div>

          <div class="d-flex align-items-center" div id="profile-button">
            <!-- Logged in Avatar -->
            <div>
              <p class=" my-auto" id="profileName">
              </p>
            </div>

            <div class="profileBtn dropdown px-3">
              <a class="btn dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown"
                aria-expanded="false">
                <img src="https://mdbcdn.b-cdn.net/img/new/avatars/2.webp" class="rounded-circle" height="25"
                  alt="Black and White Portrait of a Man" loading="lazy" />
              </a>

              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuLink">
                <li>
                  <a class="dropdown-item" href="#" onclick="createPath('pages/profile.html')">My Profile</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#" onclick="createPath('pages/cohort.html')">View Cohort</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#" onclick="logUserOut()">Log out</a>
                </li>
              </ul>

            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid px-5" style="background-color: white; width: 80%; padding-bottom: 3rem">
      <section>
        <p class="h1" style="padding-top:3rem; font-weight: 900">
          Schedule a 1:1
        </p>
        <p class="lead" style="padding-top:10px;">
          <em>Let's set you up for success</em>
        </p>
        <p>Welcome to your personalised learning experience at Code the Future!</p>
        <p>Here, you can book a 1:1 session with one of our dedicated tutors, tailored to meet your learning goals and
          schedule. Our tutors are here to support you, answer questions, and provide guidance on your web project, the
          course sessions,
          or any challenges you may encounter.</p>
        <p>To get started, select a tutor from our list, browse their availability and select a session, choose a
          session time that works best for you.</p>
      </section>

      <section>
        <p class="h4" style="padding:2rem 0 0 0.75rem; font-style:normal;">
          Select a Tutor
        </p>

        <div>
          <div id="scrollbox" style="overflow-y:auto" class="tutor-selector">
            <!-- dynamic avatars here -->
          </div>
        </div>
      </section>

      <section>
        <div class="row">
          <p class="h4" style="width:50%; padding:3rem 0 0 0.75rem; font-style:normal;">
            Select a Session
          </p>

          <div id="switch" class="d-flex mb-1">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="toggleViewSwitch">
              <label class="form-check-label" for="toggleViewSwitch" id="toggleLabel">Calendar view</label>
            </div>
          </div>

          <div id="calendar-container">
            <div id="calendar"></div> <!-- Calendar view -->
          </div>
        </div>

        <div id="tutorTableContainer">
          <table id="tutorTable">
            <thead>
              <th>Date</th>
              <th>Start time</th>
              <th>Duration</th>
              <th>Timezone</th>
              <th></th>
            </thead>

            <tbody class="sessionTable">
              <!-- tutor specific rows -->
            </tbody>
          </table>
        </div>
      </section>

      <section style="margin-top:1rem; padding-bottom:4rem;">
        <p class="h4" style="padding:3rem 0 0.75rem; font-style:normal;">
          Request an alternative 1:1 session
        </p>
        <p class="small" style="padding:0 0 1rem 0;">If none of the available sessions fit your schedule, feel free to
          request a time that works best for you. We're here to accommodate your needs, and as the saying goes, 'You
          never know unless you ask.' Don't hesitate to reach out and we'll do our best to make it happen.<br /><br />
          If you need urgent assistance use the CTF Slack channel instead as the channel is monitored daily and posting
          a question there will get you tutor support today.</p>

        <div class="row mb-4" id="alt-session">
          <div class="col-md-3">
            <h6 style="margin-bottom:0; padding-bottom:0;"><label for="txtDate" class="form-label">Select
                date:</label></h6>
            <input type="date" class="form-control" id="txtDate" />
          </div>

          <div class="col-md-3">
            <h6 style="margin-bottom:0; padding-bottom:0;"><label for="timePicker" class="form-label">Select
                time:</label></h6>
            <input type="time" class="form-control" id="timePicker" step="3600" />
          </div>

          <div class="col-md-3">
            <h6 style="margin-bottom:0; padding-bottom:0;"><label for="duration" class="form-label">Session
                duration:</label></h6>
            <select class="form-control" id="duration">
              <option>15 Mins</option>
              <option>30 Mins</option>
              <option>1 Hour</option>
            </select>
          </div>

          <div class="col-md-3 d-flex align-items-end">
            <button type="button">Request 1:1 session</button>
          </div>
        </div>

        <div id="weekend-alert"></div>
        <div id="empty-values-alert"></div>
        <div id="alert"></div>

      </section>
    </div>

    <!-- toast notifications -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">

      <div id="booked-session" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">Great news!</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Your 1:1 session has been booked.
        </div>
      </div>

      <div id="request-session" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">Great news!</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Your request for an alternative session has been sent to the Tutor.
        </div>
      </div>

      <!-- Firebase failure toast notification -->
      <div id="firebase-error-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">Bad news!</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          There was an error processing that request. Please try again.
        </div>
      </div>

    </div>

    <!-- Bootstrap Modal for displaying event details -->
    <div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="eventDetailsLabel">Select a Session: calendar entry</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p><strong>Date:</strong> <span id="eventDate"></span></p>
            <p><strong>Start time:</strong> <span id="eventStartTime"></span></p>
            <p><strong>Duration:</strong> <span id="eventDuration"></span></p>
            <p><strong>Timezone:</strong> <span id="eventTimezone"></span></p>
            <div class="alert alert-info" role="alert">
              Return to <strong>Table view</strong> to <strong>Book 1:1 session</strong>.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" id="modalClose" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script type="module">
    import { fbAuth, fbDB } from "./js/firebase.js";
    window.fbDB = fbDB;
  </script>

  <script>
    window.onload = (event) => {
      const stylesheet = document.createElement("link");
      stylesheet.rel = "stylesheet";
      stylesheet.type = "text/css";
      stylesheet.href = getPath() + "styles/mainStyle.css";
      document.head.appendChild(stylesheet);

      auth(
        document.querySelector(".loginBtn"),
        document.querySelector(".profileBtn"),
        document.querySelector("#sessionsLink")
      );
      getTutors(); // fetch tutors and load the first tutor's availability

      // disable todays date in the date picker (only allow future dates)
      const dateInput = document.getElementById('txtDate');
      const today = new Date();
      today.setDate(today.getDate() + 1); // move to tomorrow
      const formattedDate = today.toISOString().split('T')[0]; // format as YYYY-MM-DD
      dateInput.setAttribute('min', formattedDate); // set 'min' to disable today
    };

    function createPath(options) {
      window.location = getPath() + options;
      return false;
    }

    // set up the minimum and maximum date for the date picker
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];  // todays date YYYY-MM-DD format
    const year = today.getFullYear();

    document.getElementById('txtDate').min = formattedDate;
    document.getElementById('txtDate').setAttribute('max', year + '-12-31');

    const dateInput = document.getElementById('txtDate');
    const timeInput = document.getElementById('timePicker');
    const alertContainer = document.querySelector('#alert');
    const weekendAlertContainer = document.querySelector('#weekend-alert');

    // helper function to clear all alerts
    function clearAlerts() {
      if (alertContainer) alertContainer.innerHTML = '';
      if (weekendAlertContainer) weekendAlertContainer.innerHTML = '';
    }

    // function to show alerts and clear previous alerts
    function showAlert(message, type = 'danger') {
      clearAlerts(); // clear any previous alerts before showing a new one
      const alertHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          <div>${message}</div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
      alertContainer.insertAdjacentHTML('beforeend', alertHTML);
    }

    // helper function to validate if a date is valid
    function isValidDate(dateStr) {
      const date = new Date(dateStr);
      return date instanceof Date && !isNaN(date);
    }

    // debounce function to wait until typing is complete
    function debounce(func, delay) {
      let timeout;
      return function () {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
      };
    }

    // date input validation
    dateInput.addEventListener('input', debounce(function () {
      clearAlerts();

      const selectedDateStr = dateInput.value;
      // only validate when the full date is entered (YYYY-MM-DD is 10 characters)
      if (selectedDateStr.length < 10) return;

      const selectedDate = new Date(selectedDateStr);
      if (!isValidDate(selectedDateStr)) return; // ensure the entered date is valid

      const today = new Date();
      today.setHours(0, 0, 0, 0); // set to the start of today for comparison

      const day = selectedDate.getDay();

      // prevent weekend selection
      if (day === 0 || day === 6) {
        showAlert('Tutors are not accepting weekend sessions unless by pre-arrangement, please choose a suitable weekday instead.', 'info');
        dateInput.value = ''; // reset the date input
        return;
      }

      // Prevent selecting past dates
      if (selectedDate < today) {
        showAlert('You cannot select a date in the past. Please choose a valid date.');
        dateInput.value = ''; // reset the date input
        return;
      }

      // If the selected date is today, set the time input restriction
      if (selectedDate.toDateString() === today.toDateString()) {
        const currentTime = today.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        timeInput.min = currentTime; // restrict time input to future times
      } else {
        timeInput.min = ''; // clear restriction if the selected date is not today
      }
    }, 500)); // wait 500ms after typing stops before validating


    // iime input validation
    timeInput.addEventListener('input', function () {
      clearAlerts();

      const selectedDateStr = dateInput.value;
      if (!selectedDateStr) return; // exit if no date is selected

      const selectedDate = new Date(selectedDateStr);
      const today = new Date();
      const selectedTime = timeInput.value;

      // check if the selected time is in the past for todays date
      if (selectedDate.toDateString() === today.toDateString()) {
        const currentTime = today.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        if (selectedTime && selectedTime < currentTime) {
          showAlert('You cannot select a time in the past. Please choose a valid time.');
          timeInput.value = ''; // reset the time picker if a past time is chosen
        }
      }
    });

    // dismiss the alert when both fields are filled
    function checkFormCompletion() {
      const selectedDate = document.getElementById('txtDate').value;
      const selectedTime = document.getElementById('timePicker').value;
      const emptyValuesAlert = document.querySelector("#empty-values-alert");

      // if both fields have values, clear the alert
      if (selectedDate && selectedTime) {
        emptyValuesAlert.innerHTML = '';
      }
    }

    // attach event listeners to date and time inputs
    dateInput.addEventListener('input', checkFormCompletion);
    timeInput.addEventListener('input', checkFormCompletion);

    // function to handle session requests when user hits submit
    function requestSession() {
      const requestedDate = dateInput.value;
      const requestedTime = timeInput.value;
      const durationSelect = document.querySelector("#duration").value;
      const emptyValuesAlert = document.querySelector("#empty-values-alert");

      // clear previous alerts
      clearAlerts();

      // check if both date and time are filled out
      if (!requestedDate || !requestedTime) {
        const showAlert = `
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
          <div> Please choose both date and time. </div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>`;
        emptyValuesAlert.innerHTML = ''; // clear any previous alerts
        emptyValuesAlert.insertAdjacentHTML('beforeend', showAlert);

        // add listeners to check if fields are filled to remove the alert
        dateInput.addEventListener('input', checkFormCompletion);
        timeInput.addEventListener('input', checkFormCompletion);
        return;
      }

      // proceed with the request when validation passes
      const toast = new bootstrap.Toast(document.getElementById('request-session'));
      toast.show();

      writeSessionRequestToDatabase(selectedTutor, requestedDate, requestedTime, durationSelect);

      const studentName = firebase.auth().currentUser.displayName || "Unknown";
      sendAlternateSessionRequestEmail_Tutor(selectedTutor, studentName, requestedDate, requestedTime, durationSelect);

      // clear form fields after submitting a new session request
      dateInput.value = '';
      timeInput.value = '';
      document.getElementById('duration').value = '15 Mins'; // Reset to default value
    }

    const requestSessionBtn = document.querySelector("#alt-session button");
    requestSessionBtn.addEventListener("click", requestSession);

    function getTutors(firstTutor = true, previouslySelectedTutor = null) {
      const dbRef = window.fbDB.ref("tutors");
      dbRef.once("value", (snapshot) => {
        const data = snapshot.val();
        const scrollbox = document.getElementById("scrollbox");
        scrollbox.replaceChildren();

        function updateTable(selectedTutor, tutorId) {
          const sessionRows = tutorTable.querySelector(".sessionTable");
          const calendarToggle = document.getElementById('toggleViewSwitch').parentNode; // get the toggle switch container
          sessionRows.replaceChildren();

          const now = new Date();
          let hasFutureSessions = false;  // track if we find any future sessions

          if (!selectedTutor.availability || Object.keys(selectedTutor.availability).length === 0) {
            sessionRows.insertAdjacentHTML('beforeend',
              `<tr>
                <td colspan="5">This tutor has no sessions available right now, but feel free to request a session with them.</td>
              </tr>`
            );
            calendarToggle.style.display = 'none';
            return;
          }

          // loop through availability and check for future sessions
          for (let sessionId in selectedTutor.availability) {
            const session = selectedTutor.availability[sessionId];
            const date = new Date(session.date);
            const time = new Date(`${session.date}T${session.time}`);

            // skip past sessions
            if (time < now) {
              continue;
            }

            hasFutureSessions = true;  // we found at least one future session

            const formattedDate = date.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' });
            const formattedTime = isNaN(time.getTime())
              ? session.time // if time is invalid, show the time as provided
              : time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });

            const duration = session.duration;
            const timeZoneName = Intl.DateTimeFormat('en', { timeZone: session.timezone, timeZoneName: 'short' })
              .formatToParts(date)
              .find(part => part.type === 'timeZoneName').value;

            const createNewRow = `
                  <tr>
                    <td>${formattedDate}</td>
                    <td>${formattedTime}</td>
                    <td>${duration}</td>
                    <td>${timeZoneName}</td>
                    <td  align="right">
                      <button onclick="handleSessionRequest(this, true, '${sessionId}', '${tutorId}')" title="Book 1:1 session">Book 1:1 session</button>
                    </td>
                  </tr>`;
            sessionRows.insertAdjacentHTML('beforeend', createNewRow);
          }

          // if no future sessions were found, display the "no sessions available" message
          if (!hasFutureSessions) {
            sessionRows.insertAdjacentHTML('beforeend',
              `<tr>
                <td colspan="5"> This tutor has no sessions available right now, but feel free to request a session with them. </td>
              </tr>`
            );
            calendarToggle.style.display = 'none';
          } else {
            calendarToggle.style.display = 'block';
          }
        }


        // display tutors
        for (const tutorId in data) {
          const tutor = data[tutorId];
          const tutorTile = document.createElement("div");
          tutorTile.classList.add("tutor-tile");

          tutorTile.addEventListener("click", function () {
            const tutorTiles = scrollbox.querySelectorAll(".tutor-tile");
            tutorTiles.forEach(tile => tile.classList.remove("selected"));
            this.classList.add("selected");

            selectedTutor = tutor;
            updateTable(selectedTutor, tutorId);
          });

          const tutorImage = document.createElement("img");
          tutorImage.src = `../images/tutorAvatars/${tutor.avatar}`;
          tutorImage.height = 70;
          tutorImage.width = 70;
          tutorImage.style.borderRadius = "100%";
          tutorImage.style.objectFit = "cover";

          const tutorName = document.createElement("p");
          tutorName.textContent = tutor.displayName;
          tutorName.style.maxWidth = "80px";
          tutorName.style.textAlign = "center";

          tutorTile.appendChild(tutorImage);
          tutorTile.appendChild(tutorName);
          scrollbox.appendChild(tutorTile);

          if (tutorId == previouslySelectedTutor || firstTutor) {
            tutorTile.classList.add("selected");
            selectedTutor = tutor;
            updateTable(tutor, tutorId);
            firstTutor = false;
          }
        }
      });
    }

    let isBookingSession = true;  // or false depending on context

    async function handleSessionRequest(button, isBookingSession, sessionId = null, tutorId = null) {
      const currentUser = firebase.auth().currentUser;

      if (!currentUser) {
        console.log("No user is currently logged in.");
        return;
      }

      const studentEmail = currentUser.email;
      const studentName = currentUser.displayName || "Unknown";

      if (isBookingSession) {
        const row = button.parentNode.parentNode;
        const requestedDate = row.cells[0].textContent;
        const requestedTime = row.cells[1].textContent;
        const requestedDuration = row.cells[2].textContent;

        const sessionRef = fbDB.ref(`tutors/${tutorId}/availability/${sessionId}`);
        sessionRef.once("value", async (snapshot) => {
          const sessionData = snapshot.val();

          if (sessionData) {
            const tutorEmail = selectedTutor.email; // Ensure selectedTutor contains this field
            if (!tutorEmail) {
              console.error("Tutor email is not defined.");
              return;
            }

            const unifiedSessionData = {
              date: sessionData.date || requestedDate,
              time: sessionData.time || requestedTime,
              duration: sessionData.duration || requestedDuration,
              timezone: sessionData.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone,
              studentEmail: studentEmail,
              studentName: studentName,
              tutorName: sessionData.tutorName || "Unknown tutor",
              status: "booked",
              sessionRequestId: sessionData.sessionRequestId || null,
            };

            sessionRef.remove((error) => {
              if (!error) {
                const bookedSessionRef = fbDB.ref(`tutors/${tutorId}/bookedSessions`).push();
                bookedSessionRef.set(unifiedSessionData, async (error) => {
                  if (!error) {
                    console.log("Session successfully booked");

                    const toast = new bootstrap.Toast(document.getElementById('booked-session'));
                    toast.show();

                    row.remove();
                    getTutors(false, tutorId);

                    // Send emails
                    await sendSelectSession_BookedConfirmationEmail_Student(selectedTutor, requestedDate, requestedTime, requestedDuration);
                    await sendSelectSession_BookedConfirmationEmail_Tutor(tutorEmail, studentName, requestedDate, requestedTime, requestedDuration);
                  } else {
                    console.error("Error booking the session:", error);
                  }
                });
              } else {
                console.error("Error removing session from availability:", error);
              }
            });
          } else {
            console.error("Session data not found in availability.");
          }
        });
      }
    }


    async function writeSessionRequestToDatabase(tutor, requestedDate, requestedTime, requestedDuration) {
      const currentUser = fbAuth.currentUser;
      const sessionRequestRef = window.fbDB.ref("sessionRequests").push();

      const userId = currentUser.uid;
      const userEmail = currentUser.email;
      const userName = currentUser.displayName;

      // creating the consistent session data structure
      const sessionData = {
        date: requestedDate,
        time: requestedTime,
        duration: requestedDuration,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,  // add systems timezone
        studentEmail: userEmail,  // ensure studentEmail is added
        studentName: userName,  // ensure studentName is added
        tutorName: tutor.displayName,
        status: "requested",  // mark this as a requested session
        sessionRequestId: sessionRequestRef.key,  // store the sessionRequestId
      };

      // now, store this session request under the tutors requestedSessions node
      window.fbDB.ref("tutors").orderByChild("displayName").equalTo(tutor.displayName).once("value", (snapshot) => {
        const tutorData = snapshot.val();
        if (tutorData) {
          const tutorId = Object.keys(tutorData)[0];  // assuming one match for the display name
          const tutorSessionRef = window.fbDB.ref(`tutors/${tutorId}/requestedSessions`).push();
          tutorSessionRef.set(sessionData, (error) => {
            if (error) {
              console.error("Error saving session request under tutor's node:", error);
            } else {
              console.log(`Session request saved under tutor ${tutor.displayName}`);
            }
          });
        } else {
          console.error(`Tutor with displayName "${tutor.displayName}" not found.`);
        }
      });
    }

    const API_URL = "https://code-the-future-hybrid.web.app/send-email";

    // ===== SELECT a SESSION <<---- from tutor_availability
    async function sendSelectSession_BookedConfirmationEmail_Tutor(tutorEmail, studentName, requestedDate, requestedTime, requestedDuration) {
      try {
        const subject = 'Code The Future: Select a Session - 1:1 booked confirmation';
        const text = `Dear Tutor,\n\nAn available 1:1 session has been booked by ${studentName}.\n\nDetails:\nDate: ${requestedDate}\nTime: ${requestedTime}\nDuration: ${requestedDuration}\nThis email is for your records as a gentle reminder to log in to Code the Future to Manage 1:1s. It's also important that you manually set up the Teams/Slack call with ${studentName}. \n\nBest wishes,\nYour Code the Future Team`;
        const html = `
          <p>Dear Tutor,</p>
          <p>A 1:1 session has been booked by <strong>${studentName}</strong>.</p>
          <ul>
            <li><strong>Date:</strong> ${requestedDate}</li>
            <li><strong>Time:</strong> ${requestedTime}</li>
            <li><strong>Duration:</strong> ${requestedDuration}</li>
          </ul>
          <p>This email is for your records as a gentle reminder to log in to Code the Future to Manage 1:1s. It's also important that you manually set up the Teams/Slack call with ${studentName}.</p>
          <p>Best wishes, <br>Your Code the Future Team</p>
        `;


        const payload = {
          from: "no-reply@code-the-future-hybrid.web.app",
          to: tutorEmail,
          subject,
          text,
          html,
        };

        console.log("Payload for tutor email:", payload);

        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        const result = await response.json();
        if (response.ok) {
          console.log('Tutor email sent successfully:', result);
        } else {
          console.error('Failed to send tutor email:', result.error);
        }
      } catch (error) {
        console.error('Error sending tutor email:', error);
      }
    }



    // ===== SELECT a SESSION <<---- from tutor_availability
    async function sendSelectSession_BookedConfirmationEmail_Student(tutor, requestedDate, requestedTime, requestedDuration) {
      try {
        const subject = 'Code the Future: Select a Session - 1:1 booked confirmation';
        const text = `Dear Student,\n\nYour 1:1 session with ${tutor.displayName} has been confirmed.\n\nDetails:\nDate: ${requestedDate}\nTime: ${requestedTime}\nDuration: ${requestedDuration} \n\nBest wishes,\nYour Code the Future Team`;
        const html = `
          <p>Dear Student,</p>
          <p>Your 1:1 session with <strong>${tutor.displayName}</strong> has been confirmed.</p>
          <ul>
            <li><strong>Date:</strong> ${requestedDate}</li>
            <li><strong>Time:</strong> ${requestedTime}</li>
            <li><strong>Duration:</strong> ${requestedDuration}</li>
          </ul>
          <p>Best wishes, <br>Your Code the Future Team</p>
        `;

        // Call the sendEmail function from emailService.js
        const studentEmail = firebase.auth().currentUser.email;

        const payload = {
          from: "no-reply@code-the-future-hybrid.web.app", // Ensure a valid sender email is included
          to: studentEmail,
          subject,
          text,
          html,
        };

        console.log("Payload for student email:", payload);

        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        const result = await response.json();
        if (response.ok) {
          console.log('Student email sent successfully:', result);
        } else {
          console.error('Failed to send student email:', result.error);
        }
      } catch (error) {
        console.error('Error sending student email:', error);
      }
    }


    // ===== REQUEST alternative session email
    async function sendAlternateSessionRequestEmail_Tutor(tutor, studentName, requestedDate, requestedTime, requestedDuration) {
      try {
        const subject = 'Code the Future: Request an alternative 1:1 session';
        const text = `Dear ${tutor.displayName},\n\n${studentName} has requested an alternative 1:1 session.\n\nDetails:\nDate: ${requestedDate}\nTime: ${requestedTime}\nDuration: ${requestedDuration}\n\nPlease log in to Code The Future to confirm or cancel the request.\n\nBest wishes,\nYour Code the Future Team`;
        const html = `
          <p>Dear ${tutor.displayName},</p>
          <p><strong>${studentName}</strong> has requested an alternative session.</p>
          <ul>
            <li><strong>Date:</strong> ${requestedDate}</li>
            <li><strong>Time:</strong> ${requestedTime}</li>
            <li><strong>Duration:</strong> ${requestedDuration}</li>
          </ul>
          <p>Please log in to Code The Future > Manage 1:1s to confirm or cancel the request.</p>
          <p>Best wishes, <br>Your Code the Future Team</p>
        `;

        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            to: tutor.email, // Ensure `tutor.email` is available and correct
            subject,
            text,
            html,
          }),
        });

        const result = await response.json();
        if (response.ok) {
          console.log('Alternative 1:1 session request email sent successfully to tutor:', result);
        } else {
          console.error('Failed to send alternative 1:1 session request email:', result.error);
        }
      } catch (error) {
        console.error('Error sending alternative 1:1 session request email to tutor:', error);
      }
    }


    // function to show generic Firebase error toast
    function showFirebaseErrorToast() {
      const toastEl = document.getElementById('firebase-error-toast');
      const toast = new bootstrap.Toast(toastEl);
      toast.show();
    }

    function logUserOut() {
      const fbAuth = firebase.auth();
      logout(fbAuth);
    }


    let calendar;

    document.getElementById('toggleViewSwitch').addEventListener('change', function () {
      const tableView = document.querySelector('#tutorTableContainer');
      const calendarView = document.getElementById('calendar-container');
      const toggleLabel = document.getElementById('toggleLabel');

      if (this.checked) {
        // switch to calendar view
        tableView.style.display = 'none';
        calendarView.style.display = 'block';
        toggleLabel.textContent = 'Table view';

        // initialise the calendar if not already initialised
        if (!calendar) {
          calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'dayGridMonth',
            events: fetchCalendarEvents(),
            eventTimeFormat: { // add this block to control the time format
              hour: '2-digit',
              minute: '2-digit',
              hour12: false // ensure 24-hour format
            },
            eventClick: function (info) {
              const event = info.event;

              // check if event.start exists and is valid
              if (event.start) {
                const eventDate = event.start.toDateString();
                const eventStartTime = event.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                const duration = event.extendedProps.duration || 'N/A';
                const timeZoneName = event.extendedProps.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;

                // open Bootstrap modal with event details
                document.getElementById('eventDate').textContent = eventDate;
                document.getElementById('eventStartTime').textContent = eventStartTime;
                document.getElementById('eventDuration').textContent = duration;
                document.getElementById('eventTimezone').textContent = timeZoneName;

                const eventModal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
                eventModal.show();
              } else {
                console.error('Event start is undefined. Event data:', event);
              }
            },
            dayCellClassNames: function (arg) {
              const date = arg.date;
              if (date.getDay() === 0 || date.getDay() === 6) { // 0 = Sunday, 6 = Saturday
                return ['fc-day-weekend'];
              }
              return [];
            }
          });
          calendar.render();
        } else {
          // refresh events if switching back to calendar
          calendar.getEvents().forEach(event => event.remove());
          fetchCalendarEvents().forEach(event => calendar.addEvent(event));
        }
      } else {
        // switch back to table view
        tableView.style.display = 'block';
        calendarView.style.display = 'none';
        toggleLabel.textContent = 'Calendar view';
      }
    });

    // fetch events for FullCalendar from the table
    function fetchCalendarEvents() {
      const rows = document.querySelectorAll('.sessionTable tr');
      const events = [];
      const now = new Date();  // get the current date and time

      rows.forEach(row => {
        const cells = row.getElementsByTagName('td');
        if (cells.length > 0) {
          let date = cells[0].textContent.trim();
          const time = cells[1].textContent.trim();
          const duration = cells[2].textContent.trim();
          const timezone = cells[3].textContent.trim();

          // convert date from DD/MM/YYYY to YYYY-MM-DD
          const [day, month, year] = date.split('/');
          date = `${year}-${month}-${day}`;

          const dateTimeString = `${date}T${time}`;
          const startDateTime = new Date(dateTimeString);

          // skip past sessions
          if (startDateTime < now) {
            return; // skip past events
          }

          if (isNaN(startDateTime)) {
            console.error("Invalid date or time:", dateTimeString);
            return;
          }

          // calculate the end time based on the duration
          let endDateTime = new Date(startDateTime);
          if (duration.includes('Mins')) {
            const mins = parseInt(duration);
            endDateTime.setMinutes(endDateTime.getMinutes() + mins);
          } else if (duration.includes('Hour')) {
            const hours = parseInt(duration);
            endDateTime.setHours(endDateTime.getHours() + hours);
          }

          // convert startDateTime to 24-hour format for the title
          const formattedStartTime = startDateTime.toLocaleTimeString([], {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false // ensures 24-hour format
          });

          const title = `Session (${duration}) - ${formattedStartTime}`;

          events.push({
            title: title,
            start: startDateTime.toISOString(),
            end: endDateTime.toISOString(),
            allDay: false,
            extendedProps: {
              duration: duration,
              timezone: timezone
            }
          });
        }
      });

      return events;
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>

  <script type="text/javascript" src="./js/app.js"></script>
</body>

</html>