<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="Code, Future, HTML, CSS, JavaScript, IBM, CIC" />
  <meta name="description" content="Code the Future free HTML/CSS coding bootcamp" />

  <title>Code the Future</title>

  <link rel="stylesheet" href="../styles/1on1.css" />

  <!-- FullCalendar CSS & JS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <script type="module" src="./js/firebase.js"></script>
</head>



<body>
  <div class="page-content">

    <nav class="navbar navbar-expand-lg bg-light">
      <div class="container-fluid g-0">
        <a onclick="createPath('index.html')" class="navbar-brand" href="#"
          style="border-right: 2px solid #d9437a;padding-right: 10px;color: #1d0c59;">
          <img src="../images/logo.png" height="60px" alt="CTF" />
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup"
          aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse justify-content-between" id="navbarNavAltMarkup">
          <div class="navbar-nav nav-justified">
            <a class="nav-link" href="#" onclick="createPath('index.html')">About CTF</a>
            <a class="nav-link" href="#" onclick="createPath('pages/meetTheTutors.html')">Meet the tutors</a>
            <a class="nav-link  active-top-nav" aria-current="page" href="#"
              onclick="createPath('pages/1on1.html')">Schedule a 1:1</a>
            <a class="nav-link" id="jobs-nav-link" href="#" onclick="createPath('pages/jobs.html')">Jobs at IBM</a>
            <a class="nav-link" href="#" onclick="createPath('pages/courseCatalog.html')">Course Catalog</a>
            <a class="nav-link" id="sessionsLink" href="#" onclick="createPath('pages/sessions.html')">Sessions</a>
            <a class="nav-link" href="#" onclick="createPath('pages/faq.html')">FAQ</a>
          </div>

          <div class="d-flex align-items-center" id="profile-button">
            <!-- Logged in Avatar -->
            <div>
              <p class=" my-auto" id="profileName">
              </p>
            </div>

            <div class="profileBtn dropdown px-3">
              <a class="btn dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-bs-toggle="dropdown"
                aria-expanded="false">
                <img id="profile-pic-avatar" class="rounded-circle" height="25" alt="" src="../images/blank_avatar.jpg"
                  loading="lazy" />
              </a>

              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuLink">
                <li>
                  <a class="dropdown-item" href="#" onclick="createPath('pages/profile.html')">My Profile</a>
                </li>
                <li>
                  <a class="dropdown-item" href="#" onclick="createPath('pages/cohort.html')">View Cohort</a>
                </li>
                <li id="tutor-menu-item" style="display: none;"><a class="dropdown-item" href="#"
                    onclick="createPath('pages/tutorAvailability.html')">Tutor Availability</a></li>
                <li>
                  <a class="dropdown-item" href="#" onclick="logUserOut()">Log out</a>
                </li>
              </ul>

            </div>
          </div>
        </div>
      </div>
    </nav>

    <div class="container-fluid px-5" style="background-color: white; width: 80%; padding-bottom: 3rem">
      <section>
        <p class="h1" style="padding-top:3rem; font-weight: 900">
          Schedule a 1:1
        </p>
        <p class="lead" style="padding-top:10px;">
          <em>Let's set you up for success</em>
        </p>
        <p>Welcome to your personalised learning experience at Code the Future!</p>
        <p>Here, you can book a 1:1 session with one of our dedicated tutors, tailored to meet your learning goals and
          schedule. Our tutors are here to support you, answer questions, and provide guidance on your web project, the
          course sessions,
          or any challenges you may encounter.</p>
        <p>To get started, select a tutor from our list, browse their availability and select a session, choose a
          session time that works best for you.</p>
      </section>

      <ul class="nav nav-tabs" id="sessionTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="available-tab" data-bs-toggle="tab" data-bs-target="#available"
            type="button" role="tab" aria-controls="available" aria-selected="true">Available sessions</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="booked-tab" data-bs-toggle="tab" data-bs-target="#booked" type="button"
            role="tab" aria-controls="booked" aria-selected="false">Booked sessions</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="requested-tab" data-bs-toggle="tab" data-bs-target="#requested" type="button"
            role="tab" aria-controls="requested" aria-selected="false">Requested sessions</button>
        </li>
      </ul>

      <div class="tab-content" id="sessionTabContent">
        <!-- Available sessions Tab -->
        <div class="tab-pane fade show active" id="available" role="tabpanel" aria-labelledby="available-tab">
          <section>
            <p class="h4" style="padding:2rem 0 0 0.75rem; font-style:normal;">
              Select a Tutor
            </p>

            <div>
              <div id="scrollbox" style="overflow-y:auto" class="tutor-selector">
                <!-- dynamic avatars here -->
              </div>
            </div>
          </section>

          <section>
            <div class="row">
              <p class="h4" style="width:50%; padding:3rem 0 0 0.75rem; font-style:normal;">
                Select a Session
              </p>

              <div id="switch" class="d-flex mb-1">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="toggleViewSwitch">
                  <label class="form-check-label" for="toggleViewSwitch" id="toggleLabel">Calendar view</label>
                </div>
              </div>

              <div id="calendar-container">
                <div id="calendar"></div> <!-- Calendar view -->
              </div>
            </div>

            <div id="tutorTableContainer">
              <table id="tutorTable">
                <thead>
                  <th>Date</th>
                  <th>Start time</th>
                  <th>Duration</th>
                  <th>Timezone</th>
                  <th></th>
                </thead>

                <tbody class="sessionTable">
                  <!-- tutor specific rows -->
                </tbody>
              </table>
            </div>
          </section>
        </div>

        <!-- Booked sessions Tab -->
        <div class="tab-pane fade" id="booked" role="tabpanel" aria-labelledby="booked-tab">
          <section>
            <p class="h4" style="padding:2rem 0 0 0.75rem; font-style:normal;">
              Your booked sessions
            </p>
            <p class="small" style="padding:0 0 0 0.75rem;">Sessions you have successfully booked with tutors.</p>

            <div id="bookedTableContainer">
              <table id="bookedTable">
                <thead>
                  <th>Date</th>
                  <th>Start time</th>
                  <th>Duration</th>
                  <th>Timezone</th>
                  <th>Tutor</th>
                  <th></th>
                </thead>

                <tbody class="bookedTable">
                  <!-- booked sessions will be dynamically inserted here -->
                </tbody>
              </table>
            </div>
          </section>
        </div>

        <!-- Requested sessions Tab -->
        <div class="tab-pane fade" id="requested" role="tabpanel" aria-labelledby="requested-tab">
          <section>
            <p class="h4" style="padding:2rem 0 0 0.75rem; font-style:normal;">
              Your requested sessions
            </p>
            <p class="small" style="padding:0 0 0 0.75rem;">Sessions you have requested that are awaiting tutor
              confirmation.</p>

            <div id="requestedTableContainer">
              <table id="requestedTable">
                <thead>
                  <th>Date</th>
                  <th>Start time</th>
                  <th>Duration</th>
                  <th>Timezone</th>
                  <th>Tutor</th>
                  <th></th>
                </thead>

                <tbody class="requestedTable">
                  <!-- requested sessions will be dynamically inserted here -->
                </tbody>
              </table>
            </div>
          </section>
        </div>
      </div>

      <section style="margin-top:1rem; padding-bottom:4rem;">
        <p class="h4" style="padding:3rem 0 0.75rem; font-style:normal;">
          Request an alternative 1:1 session
        </p>
        <p class="small" style="padding:0 0 1rem 0;">If none of the available sessions fit your schedule, feel free to
          request a time that works best for you. We're here to accommodate your needs, and as the saying goes, 'You
          never know unless you ask.' Don't hesitate to reach out and we'll do our best to make it happen.<br /><br />
          If you need urgent assistance use the CTF Slack channel instead as the channel is monitored daily and posting
          a question there will get you tutor support today.</p>

        <div class="row mb-4" id="alt-session">
          <div class="col-md-3">
            <h6 style="margin-bottom:0; padding-bottom:0;"><label for="txtDate" class="form-label">Select
                date:</label></h6>
            <input type="date" class="form-control" id="txtDate" />
          </div>

          <div class="col-md-3">
            <h6 style="margin-bottom:0; padding-bottom:0;"><label for="timePicker" class="form-label">Select
                time:</label></h6>
            <input type="time" class="form-control" id="timePicker" step="3600" />
          </div>

          <div class="col-md-3">
            <h6 style="margin-bottom:0; padding-bottom:0;"><label for="duration" class="form-label">Session
                duration:</label></h6>
            <select class="form-control" id="duration">
              <option>15 Mins</option>
              <option>30 Mins</option>
              <option>1 Hour</option>
            </select>
          </div>

          <div class="col-md-3 d-flex align-items-end">
            <button type="button">Request 1:1 session</button>
          </div>
        </div>

        <div id="weekend-alert"></div>
        <div id="empty-values-alert"></div>
        <div id="alert"></div>

      </section>
    </div>
  </div>

  <!-- toast notifications -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">

    <div id="booked-session" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Great news!</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        Your 1:1 session has been booked.
      </div>
    </div>

    <div id="request-session" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Great news!</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        Your request for an alternative session has been sent to the Tutor.
      </div>
    </div>

    <!-- Firebase failure toast notification -->
    <div id="firebase-error-toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Bad news!</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        There was an error processing that request. Please try again.
      </div>
    </div>

  </div>

  <!-- Bootstrap Modal for displaying event details -->
  <div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="eventDetailsLabel">Select a Session: calendar entry</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p><strong>Date:</strong> <span id="eventDate"></span></p>
          <p><strong>Start time:</strong> <span id="eventStartTime"></span></p>
          <p><strong>Duration:</strong> <span id="eventDuration"></span></p>
          <p><strong>Timezone:</strong> <span id="eventTimezone"></span></p>
          <div class="alert alert-info" role="alert">
            Return to <strong>Table view</strong> to <strong>Book 1:1 session</strong>.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="modalClose" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  </div>

  <script type="module">
    import { fbAuth, fbDB, fbStorage } from "./js/firebase.js";

    window.fbAuth = fbAuth;
    window.fbDB = fbDB;
    window.fbStorage = fbStorage;
  </script>

  <script>
    function safeAuthInit() {
      const loginBtn = document.querySelector(".loginBtn") || null;
      const profileBtn = document.querySelector(".profileBtn") || null;
      const sessionsLink = document.querySelector("#sessionsLink") || null;
      if (typeof auth === "function") {
        auth(loginBtn, profileBtn, sessionsLink);
      }
    }

    function createPath(options) {
      window.location = getPath() + options;
      return false;
    }

    const API_URL = "/send-email";

    let selectedTutor = null;
    let calendar = null;

    window.addEventListener("load", async () => {
      const stylesheet = document.createElement("link");
      stylesheet.rel = "stylesheet";
      stylesheet.type = "text/css";
      stylesheet.href = getPath() + "styles/mainStyle.css";
      document.head.appendChild(stylesheet);

      safeAuthInit();

      const dateInput = document.getElementById('txtDate');
      const today = new Date();
      const formattedDate = today.toISOString().split('T')[0];
      const year = today.getFullYear();

      dateInput.min = formattedDate;
      dateInput.setAttribute('max', `${year}-12-31`);

      // block “today” on load for alt request (use tomorrow)
      const tomorrow = new Date();
      tomorrow.setDate(today.getDate() + 1);
      dateInput.setAttribute('min', tomorrow.toISOString().split('T')[0]);

      // Load tutors and initialise UI
      await getTutors(); // populates tutor tiles + table for first tutor
      await populateStudentBookedAndRequested(); // fills Booked / Requested tabs
    });

    function logUserOut() {
      if (typeof logout === "function") {
        logout(window.fbAuth);
      }
    }

    const alertContainer = document.querySelector('#alert');
    const weekendAlertContainer = document.querySelector('#weekend-alert');
    const emptyValuesAlert = document.querySelector("#empty-values-alert");
    const dateInput = document.getElementById('txtDate');
    const timeInput = document.getElementById('timePicker');

    function clearAlerts() {
      if (alertContainer) alertContainer.innerHTML = '';
      if (weekendAlertContainer) weekendAlertContainer.innerHTML = '';
      if (emptyValuesAlert) emptyValuesAlert.innerHTML = '';
    }

    function showAlert(message, type = 'danger') {
      clearAlerts();
      const alertHTML = `
      <div class="alert alert-${type} alert-dismissible fade show" role="alert">
        <div>${message}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>`;
      alertContainer.insertAdjacentHTML('beforeend', alertHTML);
    }

    function isValidDateStr(dateStr) {
      const d = new Date(dateStr);
      return d instanceof Date && !isNaN(d);
    }

    function debounce(fn, delay) {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
    }

    // Date field validation (no weekends, no past)
    dateInput.addEventListener('input', debounce(() => {
      clearAlerts();
      const v = dateInput.value;
      if (v.length < 10) return;
      if (!isValidDateStr(v)) return;

      const selected = new Date(v);
      const now = new Date();
      now.setHours(0, 0, 0, 0);

      const day = selected.getDay();
      if (day === 0 || day === 6) {
        showAlert('Tutors are not accepting weekend sessions unless by pre-arrangement, please choose a suitable weekday instead.', 'info');
        dateInput.value = '';
        return;
      }
      if (selected < now) {
        showAlert('You cannot select a date in the past. Please choose a valid date.');
        dateInput.value = '';
        return;
      }

      if (selected.toDateString() === now.toDateString()) {
        const currentTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        timeInput.min = currentTime;
      } else {
        timeInput.min = '';
      }
    }, 400));

    // Time field validation (no past times for today)
    timeInput.addEventListener('input', () => {
      clearAlerts();
      const dateV = dateInput.value;
      if (!dateV) return;
      const selected = new Date(dateV);
      const now = new Date();
      const t = timeInput.value;

      if (selected.toDateString() === now.toDateString()) {
        const currentTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        if (t && t < currentTime) {
          showAlert('You cannot select a time in the past. Please choose a valid time.');
          timeInput.value = '';
        }
      }
    });

    function checkFormCompletion() {
      if (dateInput.value && timeInput.value) emptyValuesAlert.innerHTML = '';
    }
    dateInput.addEventListener('input', checkFormCompletion);
    timeInput.addEventListener('input', checkFormCompletion);

    // ---------- Available tab ----------
    async function getTutors(firstTutor = true, previouslySelectedTutorId = null) {
      const scrollbox = document.getElementById("scrollbox");
      const tutorTable = document.getElementById("tutorTable");
      const sessionRows = tutorTable.querySelector(".sessionTable");
      const calendarToggleContainer = document.getElementById('toggleViewSwitch').closest('.form-check');

      // fetch tutors (users where tutor == true)
      const snap = await window.fbDB.ref("users").orderByChild("tutor").equalTo(true).once("value");
      const tutors = snap.val() || {};

      scrollbox.replaceChildren();

      function renderTutor(tutor, tutorId) {
        const tile = document.createElement("div");
        tile.classList.add("tutor-tile");

        tile.addEventListener("click", () => {
          scrollbox.querySelectorAll(".tutor-tile").forEach(t => t.classList.remove("selected"));
          tile.classList.add("selected");
          selectedTutor = { ...tutor, tutorId };
          updateAvailabilityTable(selectedTutor, tutorId);
        });

        const img = document.createElement("img");
        img.height = 70;
        img.width = 70;
        img.style.borderRadius = "100%";
        img.style.objectFit = "cover";

        window.fbStorage
          .ref(`profilePics/${tutorId}`)
          .getDownloadURL()
          .then(url => img.src = url)
          .catch(() => img.src = "../images/blank_avatar.jpg");

        const name = document.createElement("p");
        name.textContent = tutor.displayName || "Tutor";
        name.style.maxWidth = "80px";
        name.style.textAlign = "center";

        tile.appendChild(img);
        tile.appendChild(name);
        scrollbox.appendChild(tile);

        // preselect
        if (tutorId === previouslySelectedTutorId || firstTutor) {
          tile.classList.add("selected");
          selectedTutor = { ...tutor, tutorId };
          updateAvailabilityTable(selectedTutor, tutorId);
          firstTutor = false;
        }
      }

      function updateAvailabilityTable(tutorObj, tutorId) {
        sessionRows.replaceChildren();
        const now = new Date();
        let hasFuture = false;

        const avail = (tutorObj && tutorObj.availability) ? tutorObj.availability : {};
        const ids = Object.keys(avail);

        if (!ids.length) {
          sessionRows.insertAdjacentHTML('beforeend',
            `<tr><td colspan="5">This tutor has no sessions available right now, but feel free to request a session.</td></tr>`
          );
          calendarToggleContainer.style.display = 'none';
          return;
        }

        ids.forEach(sessionId => {
          const s = avail[sessionId];
          const date = new Date(s.date);
          const time = new Date(`${s.date}T${s.time}`);

          if (isNaN(time) || time < now) return; // skip invalid/past

          hasFuture = true;

          const formattedDate = date.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' });
          const formattedTime = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
          const tzName = (() => {
            try {
              return Intl.DateTimeFormat('en', { timeZone: s.timezone, timeZoneName: 'short' })
                .formatToParts(date).find(p => p.type === 'timeZoneName').value;
            } catch {
              return Intl.DateTimeFormat().resolvedOptions().timeZone;
            }
          })();

          sessionRows.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${formattedDate}</td>
            <td>${formattedTime}</td>
            <td>${s.duration}</td>
            <td>${tzName}</td>
            <td align="right">
              <button
                title="Book 1:1 session"
                onclick="handleSessionRequest(this, true, '${sessionId}', '${tutorId}')"
              >Book 1:1 session</button>
            </td>
          </tr>
        `);
        });

        calendarToggleContainer.style.display = hasFuture ? 'block' : 'none';

        // if calendar already exists, refresh its events
        if (calendar) {
          calendar.getEvents().forEach(e => e.remove());
          fetchCalendarEvents().forEach(e => calendar.addEvent(e));
        }
      }

      // render tutor tiles
      Object.keys(tutors).forEach(tid => renderTutor(tutors[tid], tid));
    }

    // ---------- Book/Request actions ----------
    async function handleSessionRequest(button, isBookingSession, sessionId = null, tutorId = null) {
      const currentUser = window.fbAuth.currentUser;
      if (!currentUser) {
        console.warn("No user is currently logged in.");
        return;
      }

      if (!isBookingSession) return; // this page uses booking via table button

      const row = button.closest('tr');
      const requestedDate = row.cells[0].textContent;
      const requestedTime = row.cells[1].textContent;
      const requestedDuration = row.cells[2].textContent;

      const sessionRef = window.fbDB.ref(`users/${tutorId}/availability/${sessionId}`);
      const snapshot = await sessionRef.once("value");
      const sessionData = snapshot.val();

      if (!sessionData) {
        console.error("Session data not found in availability.");
        return;
      }

      const tutorEmail = (selectedTutor && selectedTutor.email) || null;
      if (!tutorEmail) {
        console.error("Tutor email is not defined on selectedTutor.");
        return;
      }

      // Move from availability to bookedSessions
      const unified = {
        date: sessionData.date || requestedDate,
        time: sessionData.time || requestedTime,
        duration: sessionData.duration || requestedDuration,
        timezone: sessionData.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone,
        studentEmail: currentUser.email,
        studentName: currentUser.displayName || "Unknown",
        tutorName: selectedTutor.displayName || "Unknown tutor",
        status: "booked",
        sessionRequestId: sessionData.sessionRequestId || null
      };

      await sessionRef.remove();
      const bookedRef = window.fbDB.ref(`users/${tutorId}/bookedSessions`).push();
      await bookedRef.set(unified);

      // UI feedback
      new bootstrap.Toast(document.getElementById('booked-session')).show();
      row.remove();
      // refresh tutor availability so future/past logic re-applies
      await getTutors(false, tutorId);
      // refresh student's Booked tab
      await populateStudentBookedAndRequested();

      // send emails
      await sendBookedEmail_Tutor(tutorEmail, unified.studentName, unified.date, unified.time, unified.duration);
      await sendBookedEmail_Student(selectedTutor, unified.studentName, unified.date, unified.time, unified.duration);
    }

    async function writeSessionRequestToDatabase(tutor, requestedDate, requestedTime, requestedDuration) {
      const currentUser = window.fbAuth.currentUser;
      if (!currentUser) return;

      const reqRef = window.fbDB.ref("sessionRequests").push();
      const sessionData = {
        date: requestedDate,
        time: requestedTime,
        duration: requestedDuration,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        studentEmail: currentUser.email,
        studentName: currentUser.displayName || "Unknown",
        tutorName: tutor.displayName,
        status: "requested",  // mark this as a requested session
        sessionRequestId: sessionRequestRef.key,  // store the sessionRequestId
      };

      // now, store this session request under the tutors requestedSessions node
      window.fbDB.ref(`users/${tutor.tutorId}`).once("value", (snapshot) => {
        const tutorData = snapshot.val();
        if (tutorData) {
          const tutorSessionRef = window.fbDB.ref(`users/${tutor.tutorId}/requestedSessions`).push();
          tutorSessionRef.set(sessionData, (error) => {
            if (error) {
              console.error("Error saving session request under tutor's node:", error);
            } else {
              console.log(`Session request saved under tutor ${tutor.displayName}`);
            }
          });
        } else {
          console.error(`Tutor with displayName "${tutor.displayName}" not found.`);
        }
      });
    }

    // Initialize EmailJS
    emailjs.init('N0cfshULW4gnpvhdY'); // Replace with your EmailJS public key

    // ===== SELECT a SESSION <<---- from tutor_availability
    async function sendSelectSession_BookedConfirmationEmail_Tutor(tutorEmail, studentName, requestedDate, requestedTime, requestedDuration) {
      try {
        await emailjs.send('service_gos1bro', 'template_tz92f3l', {
          to_email: tutorEmail,
          recipient_name: tutor.displayName,
          attendee_name: studentName,
          session_date: requestedDate,
          session_time: requestedTime,
          session_duration: requestedDuration
        });
        console.log('Tutor email sent successfully');
      } catch (error) {
        console.error('Error sending tutor email:', error);
      }
    }

    async function sendBookedEmail_Student(tutor, studentName, requestedDate, requestedTime, requestedDuration) {
      try {
        const studentEmail = firebase.auth().currentUser.email;
        
        await emailjs.send('service_gos1bro', 'template_nlqu6we', { //student booking confirmation
          to_email: studentEmail,
          recipient_name: studentName,
          attendee_name: tutor.displayName,
          session_date: requestedDate,
          session_time: requestedTime,
          session_duration: requestedDuration
        });
        console.log('Student email sent successfully');
      } catch (error) {
        console.error('Error sending student email:', error);
      }
    }

    async function sendAlternateRequestEmail_Tutor(tutor, studentName, requestedDate, requestedTime, requestedDuration) {
      try {
        await emailjs.send('service_gos1bro', 'template_tz92f3l', { //Tutor ad hoc request
          to_email: tutor.email,
          tutor_name: tutor.displayName,
          student_name: studentName,
          session_date: requestedDate,
          session_time: requestedTime,
          session_duration: requestedDuration
        });
        console.log('Alternative 1:1 session request email sent successfully to tutor');
      } catch (error) {
        console.error('Error sending alternative 1:1 session request email to tutor:', error);
      }
    }

    // ---------- Calendar toggle ----------
    document.getElementById('toggleViewSwitch').addEventListener('change', function () {
      const tableView = document.querySelector('#tutorTableContainer');
      const calendarView = document.getElementById('calendar-container');
      const toggleLabel = document.getElementById('toggleLabel');

        tableView.style.display = 'none';
        calendarView.style.display = 'block';
        toggleLabel.textContent = 'Table view';

        if (!calendar) {
          calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'dayGridMonth',
            events: fetchCalendarEvents(),
            eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
            eventClick: (info) => {
              const e = info.event;
              if (!e.start) return;
              document.getElementById('eventDate').textContent = e.start.toDateString();
              document.getElementById('eventStartTime').textContent = e.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
              document.getElementById('eventDuration').textContent = e.extendedProps.duration || 'N/A';
              document.getElementById('eventTimezone').textContent = e.extendedProps.timezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
              new bootstrap.Modal(document.getElementById('eventDetailsModal')).show();
            },
            dayCellClassNames: (arg) => (arg.date.getDay() === 0 || arg.date.getDay() === 6) ? ['fc-day-weekend'] : []
          });
          calendar.render();
        } else {
          calendar.getEvents().forEach(ev => ev.remove());
          fetchCalendarEvents().forEach(ev => calendar.addEvent(ev));
        }
      } else {
        tableView.style.display = 'block';
        calendarView.style.display = 'none';
        toggleLabel.textContent = 'Calendar view';
      }
    });

    function fetchCalendarEvents() {
      const rows = document.querySelectorAll('.sessionTable tr');
      const events = [];
      const now = new Date();

      rows.forEach(row => {
        const tds = row.querySelectorAll('td');
        if (tds.length < 4) return;

        // DD/MM/YYYY -> YYYY-MM-DD
        const [dd, mm, yyyy] = tds[0].textContent.trim().split('/');
        const dateISO = `${yyyy}-${mm}-${dd}`;
        const time = tds[1].textContent.trim();
        const duration = tds[2].textContent.trim();
        const tz = tds[3].textContent.trim();

        const start = new Date(`${dateISO}T${time}`);
        if (isNaN(start) || start < now) return;

        const end = new Date(start);
        if (duration.includes('Mins')) end.setMinutes(end.getMinutes() + parseInt(duration));
        else if (duration.includes('Hour')) end.setHours(end.getHours() + parseInt(duration));

        const title = `Session (${duration}) - ${start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })}`;

        events.push({
          title,
          start: start.toISOString(),
          end: end.toISOString(),
          allDay: false,
          extendedProps: { duration, timezone: tz }
        });
      });

      return events;
    }
  </script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>

  <script type="text/javascript" src="./js/app.js"></script>
</body>

</html>